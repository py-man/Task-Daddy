services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    restart: unless-stopped
    labels:
      - "com.neonlanes.track=${DEPLOY_TRACK:-production}"
      - "com.neonlanes.branch=${DEPLOY_BRANCH:-main}"
    ports:
      - "${REDIS_BIND_HOST:-127.0.0.1}:${REDIS_PORT:-6379}:6379"

  db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: neonlanes
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change-me-local}
      POSTGRES_DB: neonlanes
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neonlanes -d neonlanes"]
      interval: 2s
      timeout: 3s
      retries: 20
    labels:
      - "com.neonlanes.track=${DEPLOY_TRACK:-production}"
      - "com.neonlanes.branch=${DEPLOY_BRANCH:-main}"
    ports:
      - "${DB_BIND_HOST:-127.0.0.1}:${DB_PORT:-5432}:5432"
    volumes:
      - neonlanes_db:/var/lib/postgresql/data
      - ./apps/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  api:
    build:
      context: ./apps/api
    restart: on-failure
    env_file:
      - ./apps/api/.env
    environment:
      # Keep local docker quickstart deterministic even if apps/api/.env
      # was previously customized for production credentials.
      DATABASE_URL: postgresql+asyncpg://neonlanes:${POSTGRES_PASSWORD:-change-me-local}@db:5432/neonlanes
      API_DOCS_ENABLED: "true"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    labels:
      - "com.neonlanes.track=${DEPLOY_TRACK:-production}"
      - "com.neonlanes.branch=${DEPLOY_BRANCH:-main}"
    ports:
      - "${API_BIND_HOST:-127.0.0.1}:${API_PORT:-8000}:8000"
    volumes:
      - neonlanes_uploads:/app/data/uploads
      - neonlanes_backups:/app/data/backups
    command: >
      bash -lc "cd /app &&
      if [ -z \"${APP_SECRET:-}\" ] || [ \"${APP_SECRET}\" = \"REPLACE_WITH_STRONG_RANDOM_SECRET\" ] || [ \"${APP_SECRET}\" = \"dev-secret-change-me\" ]; then
        export APP_SECRET=$$(python -c \"import secrets; print(secrets.token_urlsafe(48))\"); echo 'api: generated runtime APP_SECRET for local startup'; fi &&
      if [ -z \"${FERNET_KEY:-}\" ] || [ \"${FERNET_KEY}\" = \"REPLACE_WITH_FERNET_KEY\" ] || [ \"${FERNET_KEY}\" = \"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=\" ]; then
        export FERNET_KEY=$$(python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"); echo 'api: generated runtime FERNET_KEY for local startup'; fi &&
      until pg_isready -h db -p 5432 -U neonlanes -d neonlanes; do echo 'waiting for db'; sleep 1; done &&
      alembic upgrade head &&
      python -m app.seed &&
      uvicorn app.main:app --host 0.0.0.0 --port 8000"

  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
    restart: unless-stopped
    environment:
      API_INTERNAL_URL: http://api:8000
    depends_on:
      - api
    labels:
      - "com.neonlanes.track=${DEPLOY_TRACK:-production}"
      - "com.neonlanes.branch=${DEPLOY_BRANCH:-main}"
    ports:
      - "${WEB_BIND_HOST:-127.0.0.1}:${WEB_PORT:-3010}:3000"

volumes:
  neonlanes_db:
  neonlanes_uploads:
  neonlanes_backups:
