name: Nightly Quality Guard

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

jobs:
  codeql:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ "javascript-typescript", "python" ]
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Analyze
        uses: github/codeql-action/analyze@v3

  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: npm ci
      - run: npm run lint
      - run: npm -w @neonlanes/web run typecheck
      - run: python -m pip install -r apps/api/requirements.txt
      - run: pytest apps/api/tests -q

  security-deps-sast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: npm ci
      - run: npm audit --json > artifacts_npm_audit.json || true
      - run: python -m pip install pip-audit semgrep
      - run: pip-audit -r apps/api/requirements.txt -f json > artifacts_pip_audit.json || true
      - run: semgrep --config auto --sarif --output security.sarif . || true
      - run: SECURITY_GATE_ALLOW_HIGH=1 python3 scripts/security-gate.py | tee security_gate.txt
      - uses: actions/upload-artifact@v4
        with:
          name: nightly-security
          path: |
            artifacts_npm_audit.json
            artifacts_pip_audit.json
            security.sarif
            security_gate.txt

  security-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          if [ -f results.sarif ]; then cp results.sarif secrets.sarif; else echo '{"version":"2.1.0","runs":[]}' > secrets.sarif; fi
      - uses: actions/upload-artifact@v4
        with:
          name: nightly-secrets
          path: secrets.sarif

  perf-and-system:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: docker compose up --build -d
      - run: ./scripts/smoke.sh
      - run: ./scripts/api-contract-check.sh
      - run: ./scripts/nightly-artifacts.sh
      - uses: actions/upload-artifact@v4
        with:
          name: nightly-system
          path: artifacts/nightly

  lighthouse:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: docker compose up --build -d
      - name: Lighthouse (login)
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://127.0.0.1:3000/login
            http://127.0.0.1:3000/marketing
          uploadArtifacts: true
          temporaryPublicStorage: true

  artifacts:
    needs: [quality, security-deps-sast, security-secrets, perf-and-system, lighthouse, codeql]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/collected
          merge-multiple: true
      - run: python3 scripts/nightly-summary.py --input-dir artifacts/collected --output-dir artifacts/nightly
      - uses: actions/upload-artifact@v4
        with:
          name: nightly-report-index
          path: |
            artifacts/nightly/nightly_report.md
            artifacts/nightly/findings.json
